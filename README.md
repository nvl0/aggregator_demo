# Демонстрационная версия работы агрегатора трафика
### Зависимости
docker, docker compose

### Инструкции
```
Тесты: /src/scripts/run_test_*.sh, где * - all, pg_repository, storage_repository, usecase 
Старт сервиса: /src/scripts/start_docker.sh
```

## Схема работы агрегатора
Сервис запускается 1 раз в 60 секунд. Если предыдущий цикл не был закончен, 
то новый цикл не начнется до тех пор, пока старый цикл не завершится.

1. Считывание flow-директории. Мы получаем список nas_ip директории. Они нужны для указания путей для агрегации и фильтрации сессий.

```
Древо директории flow должно выглядеть следующим образом, где:
├ nas_ip
├── tmp
│   ├── ft-filename
├── ft-filename
└── tmp-filename

filename - название файла netflow;
nas_ip - имя директории ip nas сервера;
nas_ip/ft-filename - собранный flow за n-минут, который не был агрегирован;
nas_ip/tmp-filename - текущая трансляция flow, которая не должна быть агрегирована пока не превратится в ft-*;
tmp/ft-filename - собранный flow за n-минут, который был агрегирован;
```

2. Получение сессий из базы данных.

3. Запускается цикл c горутиной на каждый nas_ip.

4. Считывание flow происходит путем: входа в директорию, создание директории tmp, переноса готовых netflow (см. пример древа) 
файлов в директорию tmp.

5. Агрегация netflow по направлениям: внешняя сеть, внутренняя сеть. Netflow представляет из себя файл, в котором содержится информация по количеству и размеру пакетов
между ip-адресами. ByteSize, SrcAddr, DstAddr - размер переданных байтов, получатель, отправитель. Агрегация осуществляется простым сложением
количества байтов. Получатель или отправитель должен принадлежать внутренней сети. При инициализации нулевой трафик будет создан по всем
разрешенным направлениям, который в последствии будет агрегирован.

6. Просеивание трафика нужно для сопоставления ip-адресов агрегированного трафика из flow и текущих активных сессий из базы данных.
Критерии для просеиваниия следующие, чтобы трафик посчитался: сессия должна быть активной (получена из пункта 2), nas_ip сессии должен 
совпадать с nas_ip директорией flow. В противном случае трафик не будет записан. Результатом просеивания является чанк - смесь данных из актвиной сессии
и агрегированного трафика.

7. Запись чанков в базу данных.

8. Удаление подсчитанных flow. 
