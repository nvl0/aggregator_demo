# Демонстрационная версия работы агрегатора трафика

## Инструкции
docker и docker compose обязательны
```
Для запуска тестов воспользуйтесь скриптами ./run_test_*.sh из директории scripts 
Для запуска репозитарных тестов потребуется запустить postgres с помощью скрипта ./start_db.sh
Для запуска агрегатора необходимо использовать скрипт ./start_docker.sh
```

## Схема работы агрегатора
Агрегатор запускается 1 раз в 180 секунд кроном. То есть, каждую 3-ю минуту. Если предыдущий цикл агрегатора не был закончен, 
то новый цикл не начнется до тех пор, пока старый цикл не завершится.

1. Считывание flow-директории. Мы получаем список nas_ip директории. Они нужны для указания путей для агрегации и фильтрации сессий.

```Древо директории flow должно выглядеть следующим образом, где:
├ nas_ip
├── tmp
│   ├── ft-filename
├── ft-filename
└── tmp-filename

filename - название файла netflow;
nas_ip - имя директории ip nas сервера;
nas_ip/ft-filename - собранный flow за n-минут, который не был агрегирован;
nas_ip/tmp-filename - текущая трансляция flow, которая не должна быть агрегирована пока не превратится в ft-*;
tmp/ft-filename - собранный flow за n-минут, который был агрегирован;
```

2. Параллельно считывания flow-директорий выполняется получение сессий.

3. Запускается цикл с горутинами на каждый nas_ip.

4. Считывание flow происходит путем: входа в директорию, создание директории tmp, переноса готовых netflow (см. пример древа) 
файлов в директорию tmp. Считывание netflow происходит одновременно со всех файлов в директориях tmp. 
Результатом считывания будет хэш-таблица, в которой ключом будет nas_ip директория, а значением netflow по этой директории.
Таким образом мы можем отделить пустые (неиспользующиеся, невалидные и т.д.) директории от директорий в которых есть netflow.

5. Агрегация netflow по направлениям: внешняя сеть, внутренняя сеть. В глобальных константах есть хэш-таблица разрешенных направлений,
учтите это при компиляции. Netflow представляет из себя файл, в котором содержится информация по количеству и размеру пакетов
между ip-адресами. ByteSize, SrcAddr, DstAddr - размер переданных байтов, получатель, отправитель. Агрегация осуществляется простым сложением
количества байтов. Получатель или отправитель должен принадлежать внутренней сети. При инициализации нулевой трафик будет создан по всем
разрешенным направлениям, который в последствии будет агрегирован.

6. Просеивание трафика нужно для сопоставления ip-адресов агрегированного трафика из flow и текущих активных сессий из базы данных.
Критерии для просеиваниия следующие, чтобы трафик посчитался: сессия должна быть активной (получена из пункта 2), nas_ip сессии должен 
совпадать с nas_ip директорией flow. В противном случае трафик не будет записан. В случае, если трафик по какому-то их разрешенных
направлений отсутствует, то он будет заполнен нулевыми значениями. Результатом просеивания является чанк - смесь данных из актвиной сессии
и агрегированного трафика.

7. Запись чанков в базу данных.

Агрегатор завершает работу, когда все параллельные циклы по nas_ip завершат свою работу.
